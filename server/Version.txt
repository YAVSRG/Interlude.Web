better logging and many bug fixes